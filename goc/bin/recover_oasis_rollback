#!/bin/bash
# Recover after a rollback on the oasis machine, that is, after
#   re-installing on a new VM and then going back to boot a previously
#   installed VM.  Recreate repo keys for oasis & config-osg repos.
# This is a temporary implementation, see CVM-1140.

if [ ! -f /etc/cvmfs/keys/oasis.opensciencegrid.org.masterkey ]; then
    echo "Only run this on the stratum 0 with the masterkey installed"
    exit 1
fi

umountifmounted()
{
    if mount | grep -q " on $1"; then
        umount $1
    fi
}

RUNUSER="/sbin/runuser -s /bin/bash oasis -c"

# temporary for el7 and cvmfs-server-2.3.2
export CVMFS_DONT_CHECK_OVERLAYFS_VERSION=true

set -ex
for REPO in oasis config-osg; do
    cp /etc/cvmfs/repositories.d/$REPO.opensciencegrid.org/server.conf /tmp
    umountifmounted /cvmfs/$REPO.opensciencegrid.org
    umountifmounted /usr/spool/cvmfs/$REPO.opensciencegrid.org/scratch
    cvmfs_server rmfs -p -f $REPO.opensciencegrid.org
    cvmfs_server import -o oasis -r -t $REPO.opensciencegrid.org
    cp /tmp/server.conf /etc/cvmfs/repositories.d/$REPO.opensciencegrid.org
    umount /cvmfs/$REPO.opensciencegrid.org
    mount -a # re-mounts scratch filesystem
    mount /cvmfs/$REPO.opensciencegrid.org
    # make sure transaction & publish work
    $RUNUSER "cvmfs_server transaction $REPO.opensciencegrid.org"
    $RUNUSER "cvmfs_server publish $REPO.opensciencegrid.org"
done
