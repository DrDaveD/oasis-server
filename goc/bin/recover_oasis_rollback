#!/bin/bash
# Recover after a rollback on the oasis machine, that is, after
#   re-installing on a new VM and then going back to boot a previously
#   installed VM.
# Recreate .cvmfspublished & .cvmfswhitelist for oasis & config-osg repos.

MASTERKEY=/etc/cvmfs/keys/oasis.opensciencegrid.org.masterkey
if [ ! -f $MASTERKEY ] && ! cvmfs_server masterkeycard -k >/dev/null; then
    echo "Only run this on the stratum 0 with the masterkey installed"
    exit 1
fi

umountifmounted()
{
    if mount | grep -q " on $1"; then
        umount $1
    fi
}

set -ex
for REPO in oasis config-osg; do
    REPOOSG=$REPO.opensciencegrid.org
    rm -f /srv/cvmfs/$REPOOSG/.cvmfsreflog
    rm -f /var/spool/cvmfs/$REPOOSG/reflog.chksum
    cvmfs_server resign -p $REPOOSG
    if ! resign_osg_whitelist $REPOOSG; then
        # try twice because we have seen a ~0.1% failure rate
        resign_osg_whitelist $REPOOSG
    fi
done
